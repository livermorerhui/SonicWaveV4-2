# SonicWave 项目开发约定（仓库用的详细版）

本文档说明 SonicWave 各端的技术栈、架构规则和协作流程，适用于：

- 安卓 APP（用户端）
- 后台服务器：apps/backend-api
- 后台管理 Web：apps/admin-web（管理员端）

> 如果你在使用 ChatGPT/Codex 等 AI 辅助开发，建议同时查看仓库中的 `AI_DEV_PROMPT.md`，并在对话中贴给 AI。

---

## 1. 技术栈总览

- 当前主流的最佳实践，使用MVVM的结构
- **安卓 APP**：Kotlin + MVVM
- **后台服务器**：Node.js + JavaScript（CommonJS）+ Knex + MySQL
- **后台管理 Web**：TypeScript + React 18 + React Router + Vite + Vitest

---

## 2. 安卓 APP 端

### 2.1 语言与架构

- 新代码全部使用 **Kotlin**；
- 使用 **MVVM** 架构：
  - UI 层：`Activity` / `Fragment` / Compose，仅负责展示与交互；
  - ViewModel：业务逻辑 + UI 状态；
  - Repository：网络、数据库、本地存储。

### 2.2 分层边界

- UI 层不直接进行网络 / 数据库 / 硬件操作；
- ViewModel 不依赖具体 UI 类型，不持有 `Activity` / `Fragment` 引用；
- Repository 隐藏数据源实现，对外返回清晰的业务模型。

### 2.3 并发与可测试性

- 使用 Kotlin 协程 + `viewModelScope`；
- I/O 操作在 `Dispatchers.IO` 上执行；
- 异常在 ViewModel 层统一捕获并转化为 UI 状态或一次性事件；
- ViewModel 避免直接依赖 Android framework 类型，方便在 JVM 上做单元测试；
- 关键业务逻辑应在无 UI 环境下可测试。

---

## 3. 后台服务器：apps/backend-api

### 3.1 语言与模块系统

- Node.js 后端，主语言 **JavaScript**；
- `"type": "commonjs"`，入口为 `index.js`；
- 使用 CommonJS 模块系统：
  - 导入：`require(...)`
  - 导出：`module.exports = ...`
- 当前阶段不引入 TypeScript 和 ESM，如需迁移需单独设计方案（目录结构、构建脚本等）。

### 3.2 架构与接口规范

- 路由 / 控制器职责：
  - 解析和校验请求参数（包括业务约束）；
  - 调用服务层或 domain 模块执行业务逻辑；
  - 统一返回结构化响应（包含错误码、错误信息）。
- 服务层：
  - 承载具体业务逻辑；
  - 尽量保持幂等和可测试；
  - 不直接处理 HTTP 细节。
- 数据访问层（DAO / Repository）：
  - 通过 Knex / MySQL2 处理数据库操作；
  - 对外暴露明确的接口，不泄露 SQL 细节。

### 3.3 数据库与 Migration

- 所有数据库结构变更必须通过 Migration 实现；
- 每个 Migration 应包含：
  - 升级步骤（`up`）；
  - 降级步骤（`down`）；
- 在 PR 或变更说明中需要写清：
  - 新增 / 修改了哪些表或字段；
  - 对线上数据的影响；
  - 回滚时需要注意的事项。

### 3.4 错误处理与日志

- 所有涉及外部资源（数据库、第三方服务、文件系统）的操作都应有错误处理；
- 统一的错误响应格式，避免各处随意返回不同结构；
- 日志使用 `winston` 等库记录：
  - 关键请求的 trace_id / 请求路径 / 用户 ID / 状态码；
  - 重要业务链路（登录、支付、敏感操作）的开始 / 成功 / 失败。
- 日志中不直接记录密码、token 或未脱敏的隐私信息。

---

## 4. 后台管理 Web：apps/admin-web

### 4.1 语言与工具链

- 主语言：**TypeScript**
- 框架：React 18 + React Router
- 构建工具：Vite
- 测试：Vitest + Testing Library

### 4.2 分层与模式

- 使用 ViewModel Hook 模式，例如：
  - `useUsersVM.ts`
  - `useAuthVM.ts`
  - `useCustomersVM.ts`
- 约定：
  - ViewModel Hook 负责数据获取、状态管理、业务判断；
  - 页面组件调用 ViewModel Hook，并负责布局与组合；
  - 展示组件尽量无状态、无副作用，专注于 UI 呈现。
- 所有业务代码使用 `.ts` / `.tsx` 文件，禁止新增 `.js` 文件。

### 4.3 状态管理与路由

- 登录态、当前用户信息等全局状态通过统一的 Store 或顶层组件管理；
- 路由使用 React Router，采用清晰的路由结构和懒加载策略（如有需要）。

---

## 5. 数据模型与会话管理

### 5.1 数据模型分层

为提高可维护性，数据模型分为三层：

1. **DTO / Entity**
   - 对应接口返回或数据库结构；
   - 尽量贴合持久化或传输格式。
2. **Domain Model（领域模型）**
   - 业务逻辑内部使用的模型；
   - 表达业务含义，不暴露底层具体字段。
3. **UI Model**
   - UI 展示使用的模型；
   - 包含格式化后的文案等信息。

规则：

- 模型转换逻辑放在 Repository 或专门的 Mapper 中；
- UI 层不直接做 DTO → UI Model 的复杂转换。

### 5.2 会话 / 登录态管理

- 会话信息（token、用户信息）统一由会话管理模块读取 / 存储；
- 运行时登录态由中心 ViewModel / Store 维护并广播给各模块；
- 登出流程：
  - 广播“即将登出 / 已登出”事件；
  - 清空本地缓存和 token；
  - 跳转到登录页或欢迎页。

---

## 6. 错误处理、日志与安全（各端通用）

### 6.1 错误处理

- 对所有外部交互（网络、数据库、硬件等）做防御式处理；
- Android 端的错误最终应转化为 UI 状态或一次性事件；
- Web 和后端应将错误包装为统一的错误对象或响应。

### 6.2 日志与审计

- 日志中推荐包含：
  - trace_id / 请求 ID；
  - 用户 ID（如适用）；
  - 接口名 / 路径；
  - 关键参数（适当脱敏）；
  - 状态码与错误信息（如有）。
- 禁止记录：
  - 密码；
  - token；
  - 未脱敏的隐私信息（如完整身份证 / 手机号等）。

### 6.3 安全

- token 等敏感信息妥善存储（加密或安全存储）；
- 定期对依赖进行安全扫描（例如 `npm audit` 等）；
- 对外接口需要做权限校验，不能只依赖前端控制入口。

---

## 7. 开发流程与验证

### 7.1 推荐开发顺序

- 涉及接口和数据结构的需求：
  1. 设计后端接口和数据模型；
  2. 完成数据库 Migration 与服务层逻辑；
  3. 提供接口文档 / 示例响应；
  4. 再开发 APP 和管理端 Web 的功能。

### 7.2 验证与回归

每个需求在开发完成后，应提供：

- 如何在本地启动相关服务：
  - Android：如何在 Android Studio 中运行；
  - 后端：如何 `npm test` / `node index.js` / 通过 Docker 启动；
  - 管理端：如何 `npm run dev` / `npm run build`。
- 手工验证步骤：
  - 操作路径（点击 / 输入）；
  - 预期结果；
  - 错误情况下的提示。
- 回归范围：
  - 哪些已有功能可能受影响，需要重点回归。

---

## 8. 与 AI 协作（可选但推荐）

如果使用 ChatGPT / Codex 等 AI 辅助开发：

1. 建议将 `AI_DEV_PROMPT.md` 的内容作为 System Prompt 或“开发约定”发给 AI；
2. 要求 AI 在每个需求上遵循：
   - 阶段 1：逻辑分析（不写代码）；
   - 阶段 2：分阶段方案（不写代码）；
   - 阶段 3：按阶段实现代码，并写明自检项；
   - 阶段 4：给出详细的检验步骤与 Debug 建议。
3. 在 PR 描述中保留 AI 的分析和方案，方便后续审查和回溯。

---

如需对本约定进行修改，请在 PR 中明确列出变更点，并说明对现有代码库的影响。
