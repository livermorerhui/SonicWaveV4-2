# SonicWave V4 – 领域架构总览

本文档从“领域模型”的角度描述 SonicWave V4 系统的结构，而不是从“页面/接口列表”出发。

系统整体可以拆分为 **4 个业务领域** 和 **1 个支撑领域**：

1. 振动会话域（Vibration Session Domain）
2. 客户与账户域（Customer & Account Domain）
3. 遥测与审计域（Telemetry & Audit Domain）
4. 媒体播放域（Media Playback Domain）
5. 基础设施与配置域（Infrastructure & Configuration Domain）

这些领域在 Android APP、后台 API、管理端 Web 中分别有对应的实现和交互。

---

## 1. 振动会话域（Vibration Session Domain）

### 1.1 职责

振动会话域负责**生成和控制正弦波震动**，并将这套能力通过不同“模式”暴露给用户。它是整个系统的核心价值域。

### 1.2 核心概念

- **正弦波参数**：频率、强度、时长（以及后续可能扩展的波形相关参数）。
- **振动会话（Session）**：从“开始震动”到“停止震动”的一次完整过程，关联客户和参数。
- **模式（Mode）**：
  - 自选模式：从一组预设中选择方案执行。
  - 专家模式：系统内置的“专家推荐”方案。
  - 自设模式：基于客户个体定制的方案，通常本地保存。
- **硬件控制链路**：APP 通过 CH341 控制 AD9833 和 MCP41010，实现频率和强度的调节，由外部震动器实际输出震动。
- **离线测试输出**：
  - 离线模式：在没有外设情况下仍可执行会话，用于逻辑测试和演示。
  - 正弦波声音开关：通过声音模拟正弦波输出，辅助验证参数和波形是否正常。

### 1.3 典型用例（示意）

- 用户在某个模式下配置频率、强度、时长，并启动一次振动会话。
- 在会话过程中动态调整频率/强度。
- 用户在专家模式中选择一套方案，并将其另存为某客户的自设模式。
- 用户编辑自设模式，保存到本地，以后可以重复使用。
- 在离线模式下，在没有外设的环境中，通过声音或模拟输出来验证正弦波参数是否正确。

---

## 2. 客户与账户域（Customer & Account Domain）

### 2.1 职责

客户与账户域负责**身份、权限和服务对象**的管理，包括：

- APP 用户账号的注册、登录、权限。
- 客户（被服务对象）的创建和管理。
- 用户与客户之间的绑定关系。

### 2.2 核心概念

- **APP 用户（User）**：使用 APP 的操作者，有账号、密码和权限。
- **客户（Customer）**：用户服务的对象，与设备使用记录和振动会话关联。
- **权限（Roles/Permissions）**：定义用户在系统中的权限范围，例如是否可以新增客户、是否可以使用某些模式等。

### 2.3 典型用例（示意）

- 用户在 APP 中注册账号。
- 用户登录、退出登录。
- 登录后，用户为具体客户执行振动会话。
- 用户在离线模式下新增客户（本地保存），待在线时同步。
- 管理端 Web 中，管理员查看用户列表、调整用户权限。
- 管理端 Web 中，管理员查看客户列表及其关联的用户/设备/会话数量。

---

## 3. 遥测与审计域（Telemetry & Audit Domain）

### 3.1 职责

遥测与审计域负责**记录系统和用户行为**，为后期统计分析、安全审计和运行监控提供数据支持。

### 3.2 核心概念

- **APP 启动事件**：包括设备信息、IP、APP 版本、启动时间等。
- **在线心跳**：
  - APP 在线心跳：表示设备和 APP 正在运行。
  - 用户在线心跳：表示特定用户正在使用 APP。
- **操作日志（Operation Log）**：
  - 与振动会话相关的操作：客户信息、频率、强度、时长、开始/停止时间。
  - 与客户/账号相关的变更行为。

### 3.3 典型用例（示意）

- APP 启动时向服务器发送启动事件，包括设备信息和时间。
- APP 定期发送在线心跳。
- 用户登录后，APP 发送用户在线心跳。
- 每一次振动会话的开始和结束，都会被记录为一条操作日志。
- 后台服务器将上述事件持久化，后续可用于统计和分析。

---

## 4. 媒体播放域（Media Playback Domain）

### 4.1 职责

媒体播放域负责**本地音乐播放功能**，为使用体验提供辅助性支持。

### 4.2 核心概念

- **音乐库**：本地可用的音乐文件列表。
- **播放器状态**：播放中、暂停、停止、当前曲目、播放进度等。

### 4.3 典型用例（示意）

- 扫描并显示本地音乐列表。
- 播放/暂停当前音乐。
- 切换下一首或上一首音乐。
- （可选）与振动会话的节奏进行简单联动。

### 4.4 在线音乐获取与缓存

在本地音乐播放之外，系统还支持从服务器获取受保护的音频资源，并进行本地缓存：

- **授权下载**：在登录状态下，APP 通过携带访问令牌（Token）的方式，从后端下载指定的音频资源。
- **本地缓存**：下载完成后，将音频写入本地文件目录，并更新本地音乐库/播放列表，使其可以像本地音乐一样被选中播放。
- **离线播放支持**：已成功缓存的音频可以在离线模式下播放，不依赖网络。
- **容错与重试**：对下载失败的情况提供错误提示和（可选的）重试机制，避免影响现有本地音乐播放体验。

---

## 5. 基础设施与配置域（Infrastructure & Configuration Domain）

### 5.1 职责

基础设施与配置域为上述所有领域提供运行和配置支持，包括：

- 运行模式管理：在线 / 离线 / 测试。
- 功能开关与策略下发。
- 环境配置（数据库、服务器地址、日志级别等）。
- 部署和运维脚本。

### 5.2 核心概念

- **运行模式（App Mode）**：例如 ONLINE、OFFLINE、TEST。
- **功能开关（Feature Flags）**：
  - 全体功能开关。
  - 单个设备、单类用户的权限开关。
- **配置源**：本地配置文件、服务器下发配置等。
- **部署脚本**：后端部署脚本、Dockerfile 等。

### 5.3 典型用例（示意）

- 在 APP 中切换到离线模式，在没有服务器和硬件的环境下测试振动逻辑。
- 管理端 Web 中，管理员对某个设备关闭某些敏感功能。
- 管理端 Web 中，管理员对全体用户启用或关闭某个新功能。
- 后端通过配置文件或环境变量决定日志级别、数据库连接参数等。

### 5.4 控制通道与设备管控

除了本地配置和管理端配置下发，系统还通过 **控制通道（Control Channel）** 对设备进行远程管控，当前实现聚焦在“离线模式”相关能力，典型实现形式为 WebSocket 连接。

- **连接建立**：APP 在启动或进入特定模式后，与后端建立轻量级的 WebSocket 连接，并携带设备 ID、运行模式等基本标识。连接断开后，APP 会以固定约 10 秒的间隔尝试自动重连。

- **控制指令下发（当前实现范围）**：后端可以通过该通道下发与离线模式相关的控制消息，包括但不限于：
  - 允许进入离线模式；
  - 禁止进入离线模式；
  - 下发离线模式剩余时间或倒计时，在计时结束后强制退出离线模式。

- **重连与可靠性**：控制通道需要具备断线自动重连机制，并在遇到长时间无法连接或指令解析失败时记录日志，便于后续排查。当前实现采用固定约 10 秒的重连间隔。

- **能力范围提示**：目前控制消息类型仅限于离线模式的允许/禁止与强制退出，不包括任意运行模式切换或通用功能开关。后续如需支持更丰富的远程管控能力，将通过扩展控制通道协议或配合管理端配置同步实现。
